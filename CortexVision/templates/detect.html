{% extends 'base.html' %}
{% block content %}
  <h2>Detect Objects â€” upload an image or use camera</h2>

  <form action="/detect" method="post" enctype="multipart/form-data" id="detectForm">
    <label>AI Model to use for detection
      <select name="detect_model" id="detectModelSelect">
        <option value="">-- all models --</option>
      </select>
    </label>

    <label>Upload image
      <input type="file" name="image_file" id="uploadFileInput" accept="image/png,image/jpeg">
    </label>

    <input type="hidden" name="image_data" id="imageDataInput">

    <div style="margin-top:8px">
      <video id="webcamFeed" autoplay muted playsinline style="max-width:100%; border:1px solid #ccc; display:none; margin-bottom:8px"></video>
      <div>
        <button id="useCameraBtn" type="button" class="secondary">Use Camera</button>
        <button id="captureBtn" type="button">Capture from Camera & Upload</button>
      </div>
    </div>

    <div style="margin-top:8px"><button type="submit">Upload and Process</button></div>
  </form>

  {% if embed_image_available is defined and not embed_image_available %}
  <div class="warning" style="margin-top:12px;padding:8px;border:1px solid #f5c6cb;background:#fff5f6;color:#721c24;">
    Warning: server-side image embedding (SNOWFLAKE.CORTEX.EMBED_IMAGE) is not available in the connected Snowflake account.
    Image-based classification will fail. Use training/diagnostics to enable/embed functions.
  </div>
  {% endif %}

  <p class="center">Note: Camera will only start when you click "Use Camera". Predictions will be displayed on a separate results page.</p>

  <script src="/static/webcam.js"></script>
  <script>
    // populate detect model select on load
    (async function(){
      const sel = document.getElementById('detectModelSelect');
      try{
        const resp = await fetch('/api/models');
        const data = await resp.json();
        if(data && data.models){
          for(const m of data.models){
            const o = document.createElement('option'); o.value=m; o.text=m; sel.appendChild(o);
          }
        }
      }catch(err){ console.warn(err); }
    })();
  </script>
{% endblock %}
