{% extends 'base.html' %}

{% block content %}
  <div class="messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="msg-{{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <form action="/teach" method="post" id="teachForm">
    <h2>Teach the AI â€” add a class to a model</h2>
    <div class="row">
      <div class="col">
        <label>AI Model
          <select name="model_name" id="modelSelect">
            <option value="">-- select model --</option>
            {% for m in models %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="col">
        <label>Create new model
          <input type="text" name="new_model_name" id="newModelName" placeholder="New model name">
        </label>
      </div>
    </div>

    <label>Class name
      <input type="text" name="class_name" id="className" placeholder="e.g. Snow-Capped Peak" required>
    </label>

    <label>Or choose existing class for model
      <select id="classSelect" name="class_name_select">
        <option value="">-- select class --</option>
      </select>
    </label>

    <label>Number of images to download
      <input type="number" name="num_images" min="1" max="100" value="40">
    </label>

    <details style="margin-top:10px">
        <summary>Advanced settings <button id="advHelpBtn" type="button" class="help-btn" style="margin-left:8px">?</button></summary>
      <label style="margin-top:8px">Snowflake image stage
        <input type="text" name="stage_name" value="{{ config.get('IMAGE_STAGE', '@VISIONDB.HACKATHON_SCHEMA.IMAGE_STAGE') }}">
      </label>

      <label style="margin-top:8px">Embedding model
        <select name="embed_model">
          {% for em in embed_models %}
            <option value="{{ em }}">{{ em }}</option>
          {% endfor %}
        </select>
      </label>
        <p style="font-size:12px;color:#666;margin-top:6px">These are advanced: you usually don't need to change them for the hackathon.</p>
    </details>

      <!-- Advanced help modal -->
      <div id="advHelpModal" class="help-modal" role="dialog" aria-hidden="true">
        <div class="help-inner">
          <h3>Advanced options</h3>
          <p><strong>Snowflake image stage</strong>: where uploaded images are stored for the Snowflake PUT command. You can leave the default for demos.</p>
          <p><strong>Embedding model</strong>: selects the embedding model used to convert images/text into vectors. Default works for most demos.</p>
          <div style="text-align:right"><button id="advHelpClose">Close</button></div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function(){
          const btn = document.getElementById('advHelpBtn');
          const modal = document.getElementById('advHelpModal');
          const close = document.getElementById('advHelpClose');
          if(btn){ btn.addEventListener('click', ()=>{ modal.style.display='block'; modal.setAttribute('aria-hidden','false'); }); }
          if(close){ close.addEventListener('click', ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }); }
        });
      </script>
    <div style="margin-top:8px"><button type="submit">Teach the AI</button></div>
  </form>

  <p style="margin-top:18px">Want to classify an image? Go to <a href="/detect">Detect</a> to upload or use your camera (camera only starts when you choose it).</p>

  <script>
    // Populate classes when model changes. Also disable existing-class dropdown when a model is selected (per request).
    (function(){
      const modelSelect = document.getElementById('modelSelect');
      const classSelect = document.getElementById('classSelect');
      const classNameInput = document.getElementById('className');
      const newModelInput = document.getElementById('newModelName');

      // populate classes for a model and enable classSelect
      async function refreshClasses(model){
        classSelect.innerHTML = '<option value="">-- select class --</option>';
        if(!model){
          classSelect.disabled = true;
          return;
        }
        try{
          const resp = await fetch('/api/models/' + encodeURIComponent(model) + '/classes');
          const data = await resp.json();
          if(data && data.classes){
            for(const c of data.classes){
              const o = document.createElement('option'); o.value = c; o.text = c; classSelect.appendChild(o);
            }
          }
        }catch(err){ console.warn(err); }
        classSelect.disabled = false;
      }

      modelSelect.addEventListener('change', function(e){
        const model = e.target.value;
        if(model){
          // existing model chosen -> disable create-new-model input
          if(newModelInput) newModelInput.disabled = true;
          // populate and enable class select
          refreshClasses(model);
          // clear typed class name until user chooses or types
          classNameInput.value = '';
          classNameInput.disabled = false;
        }else{
          // no model chosen -> allow creating a new model and typing class
          if(newModelInput) newModelInput.disabled = false;
          classSelect.innerHTML = '<option value="">-- select class --</option>';
          classSelect.disabled = true;
          classNameInput.disabled = false;
        }
      });

      // when user selects an existing class, copy into class_name and disable editing
      classSelect.addEventListener('change', function(e){
        if(e.target.value){
          classNameInput.value = e.target.value;
          classNameInput.disabled = true; // do not allow modification of existing class
        }else{
          // choosing blank -> allow typing a new class name
          classNameInput.value = '';
          classNameInput.disabled = false;
        }
      });

      // if the user starts typing a new model name, clear modelSelect and enable class typing
      if(newModelInput){
        newModelInput.addEventListener('input', function(e){
          if(e.target.value && modelSelect.value){
            modelSelect.value = '';
            classSelect.innerHTML = '<option value="">-- select class --</option>';
            classSelect.disabled = true;
            classNameInput.disabled = false;
          }
        });
      }

      // initial state
      if(!modelSelect.value){
        classSelect.disabled = true;
        if(newModelInput) newModelInput.disabled = false;
        classNameInput.disabled = false;
      }

    })();
  </script>
{% endblock %}
