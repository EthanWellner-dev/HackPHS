{% extends 'base.html' %}

{% block content %}
  <div class="messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="msg-{{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <form action="/teach" method="post" id="teachForm">
    <h2>Teach the AI â€” add a class to a model</h2>
    <div class="row">
      <div class="col">
        <label>AI Model
          <select name="model_name" id="modelSelect">
            <option value="">-- select model --</option>
            {% for m in models %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="col">
        <label>Create new model
          <input type="text" name="new_model_name" id="newModelName" placeholder="New model name">
        </label>
      </div>
    </div>

    <label>Class name
      <input type="text" name="class_name" id="className" placeholder="e.g. Snow-Capped Peak" required>
    </label>

    <label>Or choose existing class for model
      <select id="classSelect" name="class_name_select">
        <option value="">-- select class --</option>
      </select>
    </label>

    <label>Number of images to download
      <input type="number" name="num_images" min="1" max="50" value="8">
    </label>

    <details style="margin-top:10px">
      <summary>Advanced settings</summary>
      <div class="label-with-help">
        <label style="margin-top:8px;flex:1">Snowflake image stage
          <input type="text" name="stage_name" value="{{ config.get('IMAGE_STAGE', '@VISIONDB.HACKATHON_SCHEMA.IMAGE_STAGE') }}">
        </label>
        <button type="button" class="help-btn" title="About image stages" onclick="showStageHelp()">?</button>
      </div>

      <div class="label-with-help">
        <label style="margin-top:8px;flex:1">Embedding model
          <select name="embed_model">
            {% for em in embed_models %}
              <option value="{{ em }}">{{ em }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="button" class="help-btn" title="About embedding models" onclick="showModelHelp()">?</button>
      </div>
    </details>

    <div id="stageHelp" class="help-modal" role="dialog" aria-hidden="true">
      <div class="help-inner">
        <h3>About Image Stages</h3>
        <p>The image stage controls where uploaded images are stored inside your Snowflake account (for PUT commands). You normally don't need to change this during the hackathon. Changing it is useful if you have a specific stage created in your account or are sharing a stage across projects.</p>
        <div style="text-align:right"><button onclick="hideStageHelp()">Close</button></div>
      </div>
    </div>

    <div id="modelHelp" class="help-modal" role="dialog" aria-hidden="true">
      <div class="help-inner">
        <h3>About Embedding Models</h3>
        <p>The embedding model selection chooses which embedding engine produces image/text vectors for matching. The default model works well for most demos and hackathon projects. You might change this if you need specialized embeddings or are using a custom model.</p>
        <div style="text-align:right"><button onclick="hideModelHelp()">Close</button></div>
      </div>
    </div>

    <div style="margin-top:8px"><button type="submit">Teach the AI</button></div>
  </form>

  <p style="margin-top:18px">Want to classify an image? Go to <a href="/detect">Detect</a> to upload or use your camera (camera only starts when you choose it).</p>

  <script>
    // Populate classes when model changes. Also disable existing-class dropdown when a model is selected (per request).
    (function(){
      const modelSelect = document.getElementById('modelSelect');
      const classSelect = document.getElementById('classSelect');
      const classNameInput = document.getElementById('className');

      async function refreshClasses(model){
        classSelect.innerHTML = '<option value="">-- select class --</option>';
        if(!model){ classSelect.disabled = false; return; }
        // When an existing model is chosen, disable choosing existing class for model (user requested this behavior)
        classSelect.disabled = true;
        try{
          const resp = await fetch('/api/models/' + encodeURIComponent(model) + '/classes');
          const data = await resp.json();
          // we'll not enable the select; populate it but leave disabled
          if(data && data.classes){
            for(const c of data.classes){
              const o = document.createElement('option'); o.value = c; o.text = c; classSelect.appendChild(o);
            }
          }
        }catch(err){ console.warn(err); }
      }

      modelSelect.addEventListener('change', function(e){
        const model = e.target.value;
        refreshClasses(model);
        // Also clear the typed class name to encourage typing a new one
        if(model){ classNameInput.value = ''; }
      });

      // if user chooses existing class from dropdown, copy into class_name text input on change
      classSelect.addEventListener('change', function(e){
        if(e.target.value){ classNameInput.value = e.target.value; }
      });

    })();

    // Help modal controls
    function showStageHelp(){ document.getElementById('stageHelp').style.display='flex'; }
    function hideStageHelp(){ document.getElementById('stageHelp').style.display='none'; }
    function showModelHelp(){ document.getElementById('modelHelp').style.display='flex'; }
    function hideModelHelp(){ document.getElementById('modelHelp').style.display='none'; }
  </script>
{% endblock %}
